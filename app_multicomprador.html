<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BRAM Pedidos">
<title>BRAM Offshore - Controle de Pedidos</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Righteous&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:Poppins,sans-serif;background:linear-gradient(135deg,#001529,#003a70);min-height:100vh;color:#fff;overflow-x:hidden;position:relative}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 20% 30%,rgba(0,212,255,.1),transparent 50%);pointer-events:none;z-index:0}
.container{position:relative;z-index:1;padding-bottom:80px}
.header{background:linear-gradient(135deg,rgba(0,21,41,.97),rgba(0,58,112,.97));backdrop-filter:blur(15px);padding:1rem;box-shadow:0 4px 20px rgba(0,0,0,.3);position:sticky;top:0;z-index:1000;border-bottom:2px solid #00d4ff}
.logo-section{display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem}
.logo{font-size:2.5rem;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.header-title{font-family:Righteous,cursive;font-size:1.1rem;font-weight:900;line-height:1.3}
.header-subtitle{font-size:.75rem;opacity:.8;margin-top:.25rem}
.comprador-section{margin-top:.75rem;position:relative}
.comprador-label{font-size:.7rem;opacity:.8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.4rem}
.comprador-button{background:linear-gradient(135deg,#00d4ff,#0080ff);border:none;padding:.8rem 1rem;border-radius:12px;color:#fff;font-family:Righteous,cursive;font-size:1rem;cursor:pointer;width:100%;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 15px rgba(0,212,255,.4)}
.comprador-button:active{transform:scale(.98)}
.comprador-dropdown{display:none;position:absolute;top:100%;left:0;right:0;margin-top:.5rem;background:linear-gradient(135deg,rgba(0,21,41,.98),rgba(0,58,112,.98));backdrop-filter:blur(15px);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.5);border:2px solid #00d4ff;z-index:2000;max-height:250px;overflow-y:auto}
.comprador-dropdown.active{display:block;animation:slideDown .3s ease-out}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.comprador-option{padding:.9rem 1rem;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.1);font-weight:600;display:flex;align-items:center;gap:.6rem}
.comprador-option:last-child{border:none}
.comprador-option:active{background:rgba(0,212,255,.2)}
.comprador-option.active{background:rgba(0,212,255,.3);border-left:3px solid #00d4ff}
.update-time{font-size:.65rem;opacity:.7;margin-top:.5rem;text-align:center}
.filter-bar{background:rgba(255,255,255,.1);backdrop-filter:blur(15px);padding:1rem;margin:1rem;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
.filter-label{font-size:.8rem;font-weight:700;margin-bottom:.5rem;display:block}
.area-selector{width:100%;padding:.8rem;font-size:.9rem;border:2px solid #ff6633;border-radius:12px;background:linear-gradient(135deg,#ff6633,#ffaa00);color:#fff;font-weight:700;font-family:Righteous,cursive;margin-bottom:.75rem}
.filter-select{width:100%;padding:.8rem;font-size:.9rem;border:2px solid #00d4ff;border-radius:12px;background:linear-gradient(135deg,rgba(0,58,112,.9),rgba(0,94,184,.9));color:#fff;font-weight:700}
.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;padding:0 1rem 1rem}
.kpi-card{background:linear-gradient(135deg,rgba(255,255,255,.15),rgba(255,255,255,.05));backdrop-filter:blur(15px);padding:1rem;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.3);position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gradient)}
.kpi-card[data-type="ocean"]{--gradient:linear-gradient(135deg,#001529,#005eb8)}
.kpi-card[data-type="seafoam"]{--gradient:linear-gradient(135deg,#00e676,#00c853)}
.kpi-card[data-type="coral"]{--gradient:linear-gradient(135deg,#ff3366,#ff6633)}
.kpi-card[data-type="sunset"]{--gradient:linear-gradient(135deg,#ff6633,#ffaa00)}
.kpi-card[data-type="gold"]{--gradient:linear-gradient(135deg,#ffaa00,#ff8800)}
.kpi-card[data-type="wave"]{--gradient:linear-gradient(135deg,#00d4ff,#0080ff)}
.kpi-icon{font-size:2rem;margin-bottom:.5rem}
.kpi-label{font-size:.7rem;opacity:.8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.4rem;font-weight:600}
.kpi-value{font-family:Righteous,cursive;font-size:1.8rem;font-weight:900;line-height:1}
.valor-card{background:var(--gradient);padding:1.25rem;border-radius:16px;margin:0 1rem 1rem;box-shadow:0 6px 25px rgba(0,0,0,.4);border:2px solid rgba(255,255,255,.2)}
.valor-label{font-size:.8rem;font-weight:600;margin-bottom:.5rem}
.valor-value{font-family:Righteous,cursive;font-size:1.6rem;font-weight:900;margin-bottom:.75rem}
.valor-details{font-size:.75rem;padding-top:.75rem;border-top:1px solid rgba(255,255,255,.3);line-height:1.6}
.critical-section{padding:0 1rem 1rem}
.critical-title{font-family:Righteous,cursive;font-size:1.1rem;text-align:center;margin-bottom:.5rem}
.critical-subtitle{text-align:center;font-size:.7rem;opacity:.8;margin-bottom:1rem}
.critical-card{background:linear-gradient(135deg,rgba(211,47,47,.2),rgba(244,67,54,.2));backdrop-filter:blur(15px);padding:1rem;border-radius:16px;border:2px solid rgba(244,67,54,.5);margin-bottom:1rem}
.critical-card-title{font-family:Righteous,cursive;font-size:.9rem;color:#ff6659;margin-bottom:.75rem;display:flex;align-items:center;gap:.5rem}
.critical-item{background:rgba(255,255,255,.1);padding:.9rem;border-radius:10px;margin-bottom:.6rem;display:flex;justify-content:space-between;align-items:center;border-left:3px solid #ff6659}
.critical-item-name{font-weight:600;font-size:.8rem;flex:1}
.critical-item-info{text-align:right}
.critical-item-value{font-family:Righteous,cursive;font-size:1rem;color:#ff6659}
.critical-item-detail{font-size:.7rem;opacity:.7;margin-top:.2rem}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,8,20,.95);backdrop-filter:blur(10px);z-index:10000;align-items:center;justify-content:center;padding:1rem}
.modal.active{display:flex}
.modal-content{background:linear-gradient(135deg,#001529,#003a70);padding:1.5rem;border-radius:20px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.8);border:2px solid rgba(0,212,255,.3);position:relative}
.modal-close{position:absolute;top:1rem;right:1rem;background:linear-gradient(135deg,#ff3366,#ff6633);border:none;width:36px;height:36px;border-radius:50%;color:#fff;font-size:1.3rem;cursor:pointer;line-height:1;box-shadow:0 4px 15px rgba(255,51,102,.5)}
.modal-header{font-family:Righteous,cursive;font-size:1.3rem;margin-bottom:1rem;padding-right:2rem}
.modal-stat{padding:1rem;background:linear-gradient(135deg,rgba(0,212,255,.15),rgba(0,128,255,.15));border-radius:12px;margin-bottom:.75rem;display:flex;justify-content:space-between;align-items:center;border-left:3px solid #00d4ff}
.modal-stat-label{font-weight:600;font-size:.85rem}
.modal-stat-value{font-family:Righteous,cursive;font-size:1.1rem;color:#00d4ff;text-align:right;max-width:55%;word-break:break-word}
.modal-scroll-list{max-height:350px;overflow-y:auto}
.loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(0,21,41,.98),rgba(0,58,112,.98));padding:2rem;border-radius:20px;z-index:9999;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.8);border:2px solid rgba(0,212,255,.3)}
.loading-spinner{border:4px solid rgba(0,212,255,.2);border-top:4px solid #00d4ff;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 1rem}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="loadingScreen" class="loading">
  <div class="loading-spinner"></div>
  <div style="font-size:1rem;font-weight:600">Carregando...</div>
</div>

<div class="header">
  <div class="logo-section">
    <div class="logo">üö¢</div>
    <div>
      <div class="header-title">Controle de Pedidos<br>BRAM OFFSHORE</div>
      <div class="header-subtitle">Mobile App | 2026</div>
    </div>
  </div>
  <div class="comprador-section">
    <div class="comprador-label">Comprador</div>
    <button class="comprador-button" onclick="toggleCompradorDropdown()">
      <span id="compradorAtual">Lineker</span>
      <span style="font-size:.8rem">‚ñº</span>
    </button>
    <div class="comprador-dropdown" id="compradorDropdown"></div>
    <div class="update-time" id="lastUpdate"></div>
  </div>
</div>

<div class="filter-bar">
  <label class="filter-label">üîß √Årea de Servi√ßo:</label>
  <select class="area-selector" id="areaSelector" onchange="changeArea()">
    <option value="manutencao">üîß Manuten√ß√£o</option>
    <option value="operacoes">‚öôÔ∏è Opera√ß√µes</option>
  </select>
  <label class="filter-label">üìÖ Per√≠odo:</label>
  <select class="filter-select" id="monthFilter" onchange="filterData()">
    <option value="TODOS">üìä TODOS OS MESES</option>
  </select>
</div>

<div class="container">
  <div class="kpi-grid">
    <div class="kpi-card" data-type="ocean" onclick="showKPIDetails('total')">
      <div class="kpi-icon">üì¶</div>
      <div class="kpi-label">Total</div>
      <div class="kpi-value" id="kpi-total">-</div>
    </div>
    <div class="kpi-card" data-type="seafoam" onclick="showKPIDetails('aprovados')">
      <div class="kpi-icon">‚úÖ</div>
      <div class="kpi-label">Aprovados</div>
      <div class="kpi-value" id="kpi-aprovados">-</div>
    </div>
    <div class="kpi-card" data-type="coral" onclick="showKPIDetails('pendentes')">
      <div class="kpi-icon">‚è≥</div>
      <div class="kpi-label">Pendentes</div>
      <div class="kpi-value" id="kpi-pendentes">-</div>
    </div>
    <div class="kpi-card" data-type="sunset" onclick="showKPIDetails('fornecedores')">
      <div class="kpi-icon">üè¢</div>
      <div class="kpi-label">Fornecedores</div>
      <div class="kpi-value" id="kpi-fornecedores">-</div>
    </div>
    <div class="kpi-card" data-type="gold" onclick="showKPIDetails('embarcacoes')">
      <div class="kpi-icon">‚öì</div>
      <div class="kpi-label">Embarca√ß√µes</div>
      <div class="kpi-value" id="kpi-embarcacoes">-</div>
    </div>
    <div class="kpi-card" data-type="wave" onclick="showKPIDetails('media_dia')">
      <div class="kpi-icon">üìà</div>
      <div class="kpi-label">M√©dia/Dia</div>
      <div class="kpi-value" id="kpi-media">-</div>
    </div>
  </div>

  <div class="valor-card" style="--gradient:linear-gradient(135deg,#00e676,#00c853)" onclick="showValorDetails('total')">
    <div class="valor-label">üí∞ VALOR TOTAL</div>
    <div class="valor-value" id="valor-total">-</div>
    <div class="valor-details">Toque para detalhes</div>
  </div>

  <div class="valor-card" style="--gradient:linear-gradient(135deg,#001529,#005eb8)" onclick="showValorDetails('medio')">
    <div class="valor-label">üìä VALOR M√âDIO</div>
    <div class="valor-value" id="valor-medio">-</div>
    <div class="valor-details">Toque para detalhes</div>
  </div>

  <div class="valor-card" style="--gradient:linear-gradient(135deg,#ff6633,#ffaa00)" onclick="showValorDetails('maior')">
    <div class="valor-label">‚≠ê MAIOR PEDIDO</div>
    <div class="valor-value" id="valor-maior">-</div>
    <div class="valor-details">
      <div id="maior-fornecedor">-</div>
      <div id="maior-embarcacao">-</div>
    </div>
  </div>

  <div class="critical-section">
    <div class="critical-title">üö® FORNECEDORES CR√çTICOS</div>
    <div class="critical-subtitle">Pedidos pendentes de aprova√ß√£o</div>
    <div class="critical-card">
      <div class="critical-card-title">üí∞ Top 5 - Valor Pendente</div>
      <div id="criticosValor"></div>
    </div>
    <div class="critical-card">
      <div class="critical-card-title">üìä Top 5 - Quantidade Pendente</div>
      <div id="criticosQtd"></div>
    </div>
  </div>
</div>

<div class="modal" id="detailsModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div class="modal-header" id="modalTitle">Detalhes</div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbxSVoT9gjBy0isz_fgJVIs7cYwQim0mn1is9O09ZHOPqqSD_bQ3f_1y79BE_nW-Ghz9/exec';
let DB=null;
let allData=[];
let currentArea='manutencao';
let currentComprador='Lineker';
let currentFilter='TODOS';
let compradoresDisponiveis=[];

document.addEventListener('DOMContentLoaded',loadData);

document.addEventListener('click',function(e){
  const dropdown=document.getElementById('compradorDropdown');
  const button=document.querySelector('.comprador-button');
  if(dropdown&&!dropdown.contains(e.target)&&!button.contains(e.target)){
    dropdown.classList.remove('active');
  }
});

async function loadData(){
  try{
    console.log('[APP] Carregando dados...');
    const response=await fetch(API_URL,{method:'GET',redirect:'follow'});
    if(!response.ok)throw new Error(`HTTP ${response.status}`);
    const responseText=await response.text();
    DB=JSON.parse(responseText);
    if(DB.erro)throw new Error(DB.erro);
    console.log('[APP] Dados carregados!');
    compradoresDisponiveis=DB.compradores_disponiveis;
    document.getElementById('loadingScreen').style.display='none';
    document.getElementById('lastUpdate').textContent='üïê '+new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    buildCompradorDropdown();
    changeComprador(currentComprador);
  }catch(erro){
    console.error('[ERRO]',erro);
    document.getElementById('loadingScreen').innerHTML='<div style="color:#ff6659;text-align:center"><div style="font-size:1.2rem;margin-bottom:1rem">‚ùå Erro</div><div style="font-size:.9rem">'+erro.message+'</div><button onclick="location.reload()" style="margin-top:1rem;padding:.8rem 1.5rem;background:#00d4ff;border:none;border-radius:8px;color:#001529;font-weight:700">üîÑ Recarregar</button></div>';
  }
}

function buildCompradorDropdown(){
  const dropdown=document.getElementById('compradorDropdown');
  dropdown.innerHTML='';
  compradoresDisponiveis.forEach(comprador=>{
    const option=document.createElement('div');
    option.className='comprador-option';
    if(comprador===currentComprador)option.classList.add('active');
    const icon=comprador==='CONSOLIDADO'?'üìä':'üë§';
    option.innerHTML=`<span>${icon}</span><span>${comprador}</span>`;
    option.onclick=()=>{
      changeComprador(comprador);
      dropdown.classList.remove('active');
    };
    dropdown.appendChild(option);
  });
}

function toggleCompradorDropdown(){
  document.getElementById('compradorDropdown').classList.toggle('active');
}

function changeComprador(novoComprador){
  currentComprador=novoComprador;
  document.getElementById('compradorAtual').textContent=novoComprador;
  document.querySelectorAll('.comprador-option').forEach(opt=>{
    opt.classList.remove('active');
    if(opt.textContent.trim().includes(novoComprador)){
      opt.classList.add('active');
    }
  });
  const areaSelector=document.getElementById('areaSelector');
  areaSelector.innerHTML='<option value="manutencao">üîß Manuten√ß√£o</option><option value="operacoes">‚öôÔ∏è Opera√ß√µes</option>';
  if(novoComprador==='Rafael'){
    const optConsolidado=document.createElement('option');
    optConsolidado.value='consolidado';
    optConsolidado.textContent='üìä CONSOLIDADO';
    areaSelector.appendChild(optConsolidado);
  }
  currentArea='manutencao';
  areaSelector.value='manutencao';
  changeArea();
}

function changeArea(){
  currentArea=document.getElementById('areaSelector').value;
  if(currentArea==='consolidado'&&currentComprador==='Rafael'){
    if(!DB.dados.CONSOLIDADO){
      alert('Dados consolidados n√£o dispon√≠veis');
      return;
    }
    allData=[...DB.dados.CONSOLIDADO.manutencao.dados_completos,...DB.dados.CONSOLIDADO.operacoes.dados_completos];
  }else{
    const dadosComprador=DB.dados[currentComprador];
    if(!dadosComprador){
      alert('Dados n√£o dispon√≠veis');
      return;
    }
    allData=dadosComprador[currentArea].dados_completos;
  }
  const monthFilter=document.getElementById('monthFilter');
  monthFilter.innerHTML='<option value="TODOS">üìä TODOS OS MESES</option>';
  const meses=[...new Set(allData.map(d=>d.MES_ANO))].filter(m=>m).sort();
  meses.forEach(mes=>{
    const opt=document.createElement('option');
    opt.value=mes;
    opt.textContent='üìÖ '+mes;
    monthFilter.appendChild(opt);
  });
  currentFilter='TODOS';
  filterData();
}

function filterData(){
  currentFilter=document.getElementById('monthFilter').value;
  let filteredData=allData;
  if(!(currentArea==='consolidado'&&currentComprador==='Rafael')){
    filteredData=filteredData.filter(d=>d.COMPRADOR===currentComprador);
  }
  if(currentFilter!=='TODOS'){
    filteredData=filteredData.filter(d=>d.MES_ANO===currentFilter);
  }
  updateKPIs(filteredData);
  updateCriticalSuppliers(filteredData);
}

function updateKPIs(data){
  document.getElementById('kpi-total').textContent=data.length;
  document.getElementById('kpi-aprovados').textContent=data.filter(d=>d.STATUS==='PEDIDO APROVADO').length;
  document.getElementById('kpi-pendentes').textContent=data.filter(d=>d.STATUS==='EM APROVA√á√ÉO').length;
  document.getElementById('kpi-fornecedores').textContent=new Set(data.map(d=>d.FORNECEDOR)).size;
  document.getElementById('kpi-embarcacoes').textContent=new Set(data.map(d=>d.EMBARCA√á√ÉO)).size;
  const diasUnicos=new Set(data.map(d=>d.DATA_STR)).size;
  document.getElementById('kpi-media').textContent=diasUnicos>0?(data.length/diasUnicos).toFixed(1):0;
  const valores=data.map(d=>d.VALOR);
  const total=valores.reduce((a,b)=>a+b,0);
  const maior=Math.max(...valores);
  document.getElementById('valor-total').textContent=formatCurrency(total);
  document.getElementById('valor-medio').textContent=formatCurrency(total/valores.length);
  document.getElementById('valor-maior').textContent=formatCurrency(maior);
  const maiorPedido=data.find(d=>d.VALOR===maior);
  if(maiorPedido){
    document.getElementById('maior-fornecedor').textContent='üè¢ '+maiorPedido.FORNECEDOR;
    document.getElementById('maior-embarcacao').textContent='‚öì '+maiorPedido.EMBARCA√á√ÉO;
  }
}

function updateCriticalSuppliers(data){
  const pendentes=data.filter(d=>d.STATUS==='EM APROVA√á√ÉO');
  const criticosValor={};
  const criticosQtd={};
  pendentes.forEach(d=>{
    const forn=d.FORNECEDOR;
    criticosValor[forn]=(criticosValor[forn]||0)+d.VALOR;
    criticosQtd[forn]=(criticosQtd[forn]||0)+1;
  });
  const criticosValorSorted=Object.entries(criticosValor).sort((a,b)=>b[1]-a[1]).slice(0,5);
  document.getElementById('criticosValor').innerHTML=criticosValorSorted.map(([forn,valor])=>{
    const qtd=criticosQtd[forn];
    return `<div class="critical-item" onclick="showCriticalDetails('${forn.replace(/'/g,"\\'")}')"><span class="critical-item-name">${forn}</span><div class="critical-item-info"><div class="critical-item-value">${formatCurrency(valor)}</div><div class="critical-item-detail">${qtd} pedido${qtd>1?'s':''}</div></div></div>`;
  }).join('');
  const criticosQtdSorted=Object.entries(criticosQtd).sort((a,b)=>b[1]-a[1]).slice(0,5);
  document.getElementById('criticosQtd').innerHTML=criticosQtdSorted.map(([forn,qtd])=>{
    const valor=criticosValor[forn];
    return `<div class="critical-item" onclick="showCriticalDetails('${forn.replace(/'/g,"\\'")}')"><span class="critical-item-name">${forn}</span><div class="critical-item-info"><div class="critical-item-value">${qtd} pedido${qtd>1?'s':''}</div><div class="critical-item-detail">${formatCurrency(valor)}</div></div></div>`;
  }).join('');
}

function showCriticalDetails(fornecedor){
  const modal=document.getElementById('detailsModal');
  const title=document.getElementById('modalTitle');
  const body=document.getElementById('modalBody');
  let filteredData=allData;
  if(!(currentArea==='consolidado'&&currentComprador==='Rafael')){
    filteredData=filteredData.filter(d=>d.COMPRADOR===currentComprador);
  }
  if(currentFilter!=='TODOS')filteredData=filteredData.filter(d=>d.MES_ANO===currentFilter);
  const pendentes=filteredData.filter(d=>d.STATUS==='EM APROVA√á√ÉO'&&d.FORNECEDOR===fornecedor);
  const totalValor=pendentes.reduce((sum,d)=>sum+d.VALOR,0);
  title.textContent='üö® Pendentes - '+fornecedor;
  let content=`<div class="modal-stat"><span class="modal-stat-label">Total Pendentes</span><span class="modal-stat-value">${pendentes.length}</span></div><div class="modal-stat"><span class="modal-stat-label">Valor Total</span><span class="modal-stat-value">${formatCurrency(totalValor)}</span></div><div style="margin-top:1rem;margin-bottom:.75rem;font-weight:600;">üìã Pedidos:</div><div class="modal-scroll-list">`;
  pendentes.forEach((p,idx)=>{
    content+=`<div class="modal-stat"><div><div class="modal-stat-label">#${idx+1} - ${p.DATA_STR}</div><div style="font-size:.75rem;opacity:.7;margin-top:.2rem;">‚öì ${p.EMBARCA√á√ÉO}</div>${currentArea==='consolidado'?`<div style="font-size:.7rem;color:#00d4ff;margin-top:.2rem;">üë§ ${p.COMPRADOR}</div>`:''}</div><span class="modal-stat-value">${formatCurrency(p.VALOR)}</span></div>`;
  });
  content+='</div>';
  body.innerHTML=content;
  modal.classList.add('active');
}

function showKPIDetails(type){
  const modal=document.getElementById('detailsModal');
  const title=document.getElementById('modalTitle');
  const body=document.getElementById('modalBody');
  let filteredData=allData;
  if(!(currentArea==='consolidado'&&currentComprador==='Rafael')){
    filteredData=filteredData.filter(d=>d.COMPRADOR===currentComprador);
  }
  if(currentFilter!=='TODOS')filteredData=filteredData.filter(d=>d.MES_ANO===currentFilter);
  let content='';
  switch(type){
    case 'total':
      title.textContent='üì¶ Total de Pedidos';
      const porMes={};
      filteredData.forEach(d=>{if(d.MES_ANO)porMes[d.MES_ANO]=(porMes[d.MES_ANO]||0)+1;});
      content=Object.entries(porMes).sort().map(([mes,qtd])=>`<div class="modal-stat"><span class="modal-stat-label">üìÖ ${mes}</span><span class="modal-stat-value">${qtd}</span></div>`).join('');
      break;
    case 'aprovados':
      title.textContent='‚úÖ Aprovados';
      const aprovados=filteredData.filter(d=>d.STATUS==='PEDIDO APROVADO');
      const valorTotal=aprovados.reduce((sum,d)=>sum+d.VALOR,0);
      content=`<div class="modal-stat"><span class="modal-stat-label">Total</span><span class="modal-stat-value">${aprovados.length}</span></div><div class="modal-stat"><span class="modal-stat-label">Valor</span><span class="modal-stat-value">${formatCurrency(valorTotal)}</span></div><div class="modal-stat"><span class="modal-stat-label">%</span><span class="modal-stat-value">${((aprovados.length/filteredData.length)*100).toFixed(1)}%</span></div>`;
      break;
    case 'pendentes':
      title.textContent='‚è≥ Em Aprova√ß√£o';
      const pendentes=filteredData.filter(d=>d.STATUS==='EM APROVA√á√ÉO');
      const valorPendente=pendentes.reduce((sum,d)=>sum+d.VALOR,0);
      content=`<div class="modal-stat"><span class="modal-stat-label">Total</span><span class="modal-stat-value">${pendentes.length}</span></div><div class="modal-stat"><span class="modal-stat-label">Valor</span><span class="modal-stat-value">${formatCurrency(valorPendente)}</span></div><div class="modal-stat"><span class="modal-stat-label">%</span><span class="modal-stat-value">${((pendentes.length/filteredData.length)*100).toFixed(1)}%</span></div>`;
      break;
    case 'fornecedores':
      title.textContent='üè¢ Fornecedores';
      const fornMap={};
      filteredData.forEach(d=>{fornMap[d.FORNECEDOR]=(fornMap[d.FORNECEDOR]||0)+1;});
      content='<div class="modal-scroll-list">'+Object.entries(fornMap).sort((a,b)=>b[1]-a[1]).map(([forn,qtd])=>`<div class="modal-stat"><span class="modal-stat-label">${forn}</span><span class="modal-stat-value">${qtd}</span></div>`).join('')+'</div>';
      break;
    case 'embarcacoes':
      title.textContent='‚öì Embarca√ß√µes';
      const embMap={};
      filteredData.forEach(d=>{embMap[d.EMBARCA√á√ÉO]=(embMap[d.EMBARCA√á√ÉO]||0)+1;});
      content='<div class="modal-scroll-list">'+Object.entries(embMap).sort((a,b)=>b[1]-a[1]).map(([emb,qtd])=>`<div class="modal-stat"><span class="modal-stat-label">${emb}</span><span class="modal-stat-value">${qtd}</span></div>`).join('')+'</div>';
      break;
    case 'media_dia':
      title.textContent='üìà M√©dia/Dia';
      const diasUnicos=new Set(filteredData.map(d=>d.DATA_STR)).size;
      const mediaDia=diasUnicos>0?(filteredData.length/diasUnicos).toFixed(2):0;
      content=`<div class="modal-stat"><span class="modal-stat-label">M√©dia</span><span class="modal-stat-value">${mediaDia}</span></div><div class="modal-stat"><span class="modal-stat-label">Dias</span><span class="modal-stat-value">${diasUnicos}</span></div><div class="modal-stat"><span class="modal-stat-label">Total</span><span class="modal-stat-value">${filteredData.length}</span></div>`;
      break;
  }
  body.innerHTML=content;
  modal.classList.add('active');
}

function showValorDetails(type){
  const modal=document.getElementById('detailsModal');
  const title=document.getElementById('modalTitle');
  const body=document.getElementById('modalBody');
  let filteredData=allData;
  if(!(currentArea==='consolidado'&&currentComprador==='Rafael')){
    filteredData=filteredData.filter(d=>d.COMPRADOR===currentComprador);
  }
  if(currentFilter!=='TODOS')filteredData=filteredData.filter(d=>d.MES_ANO===currentFilter);
  let content='';
  if(type==='total'){
    title.textContent='üí∞ Valor Total';
    const fornValor={};
    filteredData.forEach(d=>{fornValor[d.FORNECEDOR]=(fornValor[d.FORNECEDOR]||0)+d.VALOR;});
    content='<div class="modal-scroll-list">'+Object.entries(fornValor).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([forn,valor])=>`<div class="modal-stat"><span class="modal-stat-label">${forn}</span><span class="modal-stat-value">${formatCurrency(valor)}</span></div>`).join('')+'</div>';
  }else if(type==='medio'){
    title.textContent='üìä Valor M√©dio';
    const fornData={};
    filteredData.forEach(d=>{
      if(!fornData[d.FORNECEDOR])fornData[d.FORNECEDOR]={total:0,count:0};
      fornData[d.FORNECEDOR].total+=d.VALOR;
      fornData[d.FORNECEDOR].count++;
    });
    const mediaFornecedores=Object.entries(fornData).map(([forn,data])=>{
      return{fornecedor:forn,media:data.total/data.count,count:data.count};
    }).sort((a,b)=>b.media-a.media);
    content='<div class="modal-scroll-list">'+mediaFornecedores.map(f=>`<div class="modal-stat"><div><div class="modal-stat-label">${f.fornecedor}</div><div style="font-size:.7rem;opacity:.7;margin-top:.2rem;">${f.count} pedido${f.count>1?'s':''}</div></div><span class="modal-stat-value">${formatCurrency(f.media)}</span></div>`).join('')+'</div>';
  }else if(type==='maior'){
    title.textContent='‚≠ê Maior Pedido';
    const maior=Math.max(...filteredData.map(d=>d.VALOR));
    const pedidoMaior=filteredData.find(d=>d.VALOR===maior);
    if(pedidoMaior){
      content=`<div class="modal-stat"><span class="modal-stat-label">Valor</span><span class="modal-stat-value">${formatCurrency(pedidoMaior.VALOR)}</span></div><div class="modal-stat"><span class="modal-stat-label">Fornecedor</span><span class="modal-stat-value">${pedidoMaior.FORNECEDOR}</span></div><div class="modal-stat"><span class="modal-stat-label">Embarca√ß√£o</span><span class="modal-stat-value">${pedidoMaior.EMBARCA√á√ÉO}</span></div><div class="modal-stat"><span class="modal-stat-label">Data</span><span class="modal-stat-value">${pedidoMaior.DATA_STR}</span></div><div class="modal-stat"><span class="modal-stat-label">Status</span><span class="modal-stat-value">${pedidoMaior.STATUS}</span></div><div class="modal-stat"><span class="modal-stat-label">Comprador</span><span class="modal-stat-value">${pedidoMaior.COMPRADOR}</span></div>`;
    }
  }
  body.innerHTML=content;
  modal.classList.add('active');
}

function closeModal(){
  document.getElementById('detailsModal').classList.remove('active');
}

document.getElementById('detailsModal').addEventListener('click',function(e){
  if(e.target===this)closeModal();
});

function formatCurrency(value){
  return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(value);
}

if('serviceWorker'in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('service-worker.js').then(reg=>{
      console.log('[SW] Registrado');
    }).catch(err=>console.log('[SW] Erro:',err));
  });
}
</script>
</body>
</html>
